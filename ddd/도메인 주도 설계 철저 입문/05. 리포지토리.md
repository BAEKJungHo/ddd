# 리포지토리

리포지토리는 데이터와 관계된 처리를 분리하기 위해서 사용한다.

리포지토리는 `Persistence` 를 담당한다. 데이터스토어를 다루는 코드는 프로그램의 의도를 가리기 쉽다. 

__의도가 잘 드러나게 하기 위해서는 데이터스토어와 관련된 처리를 따로 떼어내야 한다.__

리포지토리는 이러한 처리를 추상적으로 다룰 수 있게 해주며, 코드의 의도가 더 잘드러나게 해준다. 또한 데이터 관련 처리를 리포지토리에게 맡기면 데이터스토어의 교체가 쉬워지고, 테스트 및 프로그램의 변경이 용이해진다.

__즉, 리포지토리는 소프트웨어의 유연성에 기여하는 중요한 패턴이다.__

## 리포지토리란 ?

데이터 보관 창고를 의미한다.

객체를 다시 이용하려면 데이터스토어에 객체 데이터를 저장 및 복원할 수 있어야 한다. 리포지토리는 데이터를 저장하고 복원하는 처리를 추상화하는 객체다.

즉, 데이터의 저장, 조회, 수정, 삭제 등의 기능을 리포지토리가 담당한다. 

__리포지토리는 기술적인 요소들을 한 곳에 모음으로써, 도메인을 잘 나타내기 위한 역할을 한다.__

## 리포지토리의 책임

리포지토리의 책임은 도메인 객체를 저장하고 복원하는 Persistence 이다.

퍼시스턴시의 기반 기술은 RDB 외에도 다양하다. NoSQL 도 있다.

리포지토리에서 담당해야할 책임을 도메인 객체에 미루게 되면, 코드의 의도를 파악하기도 어렵고 지저분 해지며, 중복이 발생할 가능성이 높다.

## 리포지토리 인터페이스

```java
public interface UserInterface {
  void create(User user);
  User find(String userId);
  boolean isExists(User user);
}
```

위 처럼 사용자 이름이 중복되었는지 확인하는 책임(isExists)이 리포지토리에 구현되어있으면, 리포지토리 구현에 따라 동작 내용이 바뀔 수 있다.
사용자명 중복 확인의 주체는 도메인 서비스가 되어야 한다.

```java
@RequiredArgsConstructor
public class UserService {
  
  private final UserRepository userRepository;
  
  public boolean isExists(User user) {
    // 중복 확인 기준이 사용자 명이라는 지식이 도메인 객체에서 누락된다.
    return userRepository.isExists(user);
  }
  
}
```

위 처럼 하게될 경우 중복 확인 기준이 사용자 명이라는 지식이 도메인 객체에서 누락된다. 직접 SQL 을 까봐야 사용자 명으로 중복을 확인한다는 점을 알기 때문에, 비지니스 로직이 자연스레 SQL 에 묶이게 되는 현상이 발생해서, 객체지향이 아닌 데이터 중심의 설계로 흘러갈 수 있다.

__인프라를 다루는 처리를 도메인 서비스에 두는 것이 꺼려져 리포지토리에 사용자명 중복 확인을 정의하고 싶으면 중복 확인 키를 전달하는 형태로 작성하는 것이 좋다.__

```java
public interface UserInterface {
  void create(User user);
  User find(String userId);
  boolean isExists(String userName);
}
```

혹은 메서드 명을 좀더 명확하게 표현해줄 수도 있다.

```java
boolean isExistsByUserName(String userName);
```

## 리포지토리에 정의되는 행동

- 객체의 저장과 관련된 행위
- 수정과 관련된 행위
  - Bad Case : 수정할 항목만을 인자로 받는 경우
    - Ex. void updateName(String name);
  - Bad Case : 불필요하게 많은 수정메서드가 있는 경우
    - Ex. void updateName / void updateEmail

객체가 저장하고 있는 데이터를 수정하려면 객체 자신에게 맡기는 것이 좋다. 객체를 생성하는 처리 또한 마찬가지다.

리포지토리는 단순하게 create, update 정도의 메서드만 있으면 되고 실제로 데이터스토어에 저장하기 위한 객체를 생성하는 행위(create, update)를 도메인 객체인 엔티티에 정의하는것이 맞다.

## 정리

로직이 특정한 인프라스트럭처 기술에 의존하면 소프트웨어가 경직되는 현상이 일어난다. 코드의 대부분이 기술적인 요소들과 결합하여 의도가 제대로 드러나지 않는다.

따라서, 리포지토리라는 패턴을 사용하여 도메인의 의도를 잘 드러냄과 동시에 데이터 퍼시스턴스와 관련된 처리를 추상화할 수 있다.
