# 데이터의 무결성 유지하기

## 무결성이란 ?

무결성이란 `서로 모순이 없고 일관적`이라는 의미이다. 

## 무결성 유지 1 - Unique Key

Unique Key 제약은 데이터베이스의 특정 컬럼 값이 각각 유일하게 보장되도록 하는 기능이다.

### 유일 키 제약에 중복 확인을 맡겼을 경우 문제점

- 소스에 중복확인 로직이 필요 없다고 판단해서 지워버리게 되면 코드를 보고 `매커니즘`을 이해할 수 없다.
- 데이터베이스 기술에 의존하게 된다.
  - __비지니스 로직은 특정한 기술에 의존하면 안 된다.__
  - 만약에, 중복 기준이 사용자 명에서 이메일로 변경된다면, 코드에 중복 확인 로직이 없는 경우 데이터베이스의 제약조건을 변경해야 한다는 것을 알 수 없다.

### 유일 키 제약의 올바른 활용

개발자도 사람이기 때문에 오해하고 실수를 할 수있다. 예를 들어, 중복 확인 로직의 조건이 이메일인데, 실수로 이름으로 코드 작성을 한 경우, 유일 키가 걸려있지 않다면
데이터의 무결성을 보장할 수 없다.

__즉, 유일 키 제약은 소프트웨어의 안전성을 더 향상 시키기 위한 안전망의 역할로 사용해야 한다.__

## 무결성 유지 2 - Transacation

트랜잭션은 커밋과 롤백으로 데이터의 무결성을 지킨다. 예를 들어, 쇼핑을 하는데 구매자가 상품 구입을 요청하면 재고를 확인하고 결제를 하고 재고를 감소한 다음 구입을 확정 짓는다.
만약, 이 과정 중에 버그가 발생해서 상품 구입에 실패한 경우, 구매하지 못했는데 결제만 되면 안 되기 때문이다.

하지만 트랜잭션은 SQL Connection 을 사용하는 즉, 데이터베이스 기술에 의존한다.

### 트랜잭션 범위를 사용하는 패턴

__비지니스 로직에서는 데이터 무결성을 확보하기 위한 구체적인 구현 코드 보다는 '이 부분에서 데이터 무결성을 확보해야 한다.' 라는 것을 명시적으로 보여주는 코드가 담겨야 한다.__

C# 에서는 `TransactionScope(트랜잭션 범위)` 라는 기능을 제공한다.

```java
using(var transaction = new TransactionScope()) {
  // 생략
}
```
### AOP 를 사용하는 패턴

Java 에서는 `@Transacational` 어노테이션을 지원한다. 이 기술은 AOP 가 적용 되었다. c# 의 트랜잭션 범위보다 AOP 를 적용한 자바의 @Transacational 어노테이션이 훨씬 좋다.

트랜잭션의 범위에는 메서드 구현부를 봐야 알 수 있지만, 어노테이션의 경우에는 메서드 시그니처 바로 위에 달기 때문에, 메서드 선언부 부분만 보고도, 데이터의 무결성을 유지해야하는지 여부를 쉽게 알 수 있다.

### 유닛오브워크를 사용하는 패턴

유닛오브워크(UnitOfWork) 패턴도 트랜잭션을 다루기 위한 목적으로 사용할 수 있다.

유닛오브워크는 어떤 객체의 변경사항을 기록하는 객체다.

- UnitOfWork

```java
public class UnitOfWork {
  public void registerNew(Object obj);
  public void registerDeleted(Object obj);
  public void commit();
  // 생략
}
```

Register 로 시작하는 메서드는 인스턴스의 상태가 변경될 때마다 그 내용을 기록한다. commit 메서드가 호출되면 그 때까지 기록햇던 변경 사항을 데이터베이스에 저장한다.

c# 의 `Entity Framework` 가 유닛오브워크를 구현한 예이다.

### 트랜잭션으로 인한 락(Lock)

트랜잭션은 일관성 유지를 위해 데이터에 락(Lock)을 건다. 이때 락 범위를 항상 염두해 둬야 한다.

트랜잭션으로 인한 락(Lock) 범위를 최소한으로 해야 한다. 락의 범위가 너무 넓어지면 그에 비례해 처리의 실패 가능성이 높아진다.

1개의 트랜잭션으로 저장하는 객체의 수를 1개로 제한하고 객체의 크기를 가능한 한 줄이는 방법으로 락의 범위를 최소화 할 수 있다.
